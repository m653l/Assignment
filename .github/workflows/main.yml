name: Publish

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: 'Get the branch name'
      id: branch-name
      uses: tj-actions/branch-names@v5

    - name: 'Set RAW_BRANCH variable'
      run: echo "RAW_BRANCH=${{ steps.branch-name.outputs.current_branch }}" >> $GITHUB_ENV

    - name: 'Checkout repo'
      uses: actions/checkout@v2

    - name: 'Sets branch-related variables'
      run: echo "BRANCH=master" >> $GITHUB_ENV

    - name: 'Set SHA variable'
      run: echo "SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

    - name: 'Set TAG variable'
      run: echo "TAG=${{ env.BRANCH }}-$(date "+%Y.%m.%d")-${{ env.SHA }}" >> $GITHUB_ENV

    - name: 'Login via Azure CLI'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
